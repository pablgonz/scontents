\documentclass{article}
\usepackage{scontents} % v1.2d git

% only for test
\usepackage[top=0.5in,bottom=0.5in, left=1in, right=1in]{geometry}
\usepackage{pgffor}
\usepackage{fvextra}
\usepackage{listings}
\setlength{\parindent}{0pt}

%\ExplSyntaxOn
%\iow_new:N \l__scontents_file_iow
%\tl_new:N \l__scontents_file_tl
%\tl_new:N \g__scontents_temp_tl
%\tl_const:Nx \c__scontents_end_env_tl
  %{ \c_backslash_str end \c_left_brace_str scontents \c_right_brace_str }
%\cs_new:Npx \__scontents_tab: { \c_space_tl }
%\cs_new:Npn \__scontents_par: { ^^J ^^J }
%\cs_new_protected:Npn \__scontents_set_active_eq:NN #1
  %{
    %\char_set_catcode_active:N #1
    %\char_set_active_eq:NN #1
  %}
%\cs_new_protected:Npn \__scontents_make_control_chars_active:
  %{
    %\__scontents_set_active_eq:NN \^^M \__scontents_M:w
    %\__scontents_set_active_eq:NN \^^L \__scontents_par:
    %\__scontents_set_active_eq:NN \^^I \__scontents_tab:
  %}
%\group_begin:
  %\char_set_catcode_active:N \^^M
  %\char_set_catcode_active:N \^^L
  %\char_set_catcode_active:N \^^I
  %\cs_gset_protected:Npn \__scontents_start_environment:w #1 ^^M
    %{
      %\__scontents_environment_inline:w #1 \q__scontents_mark
      %\__scontents_make_control_chars_active:
      %\group_begin:
        %\__scontents_file_tl_write_start:V \l__scontents_fname_out_tl
          %^^M
    %}
  %\cs_gset_protected:Npn \__scontents_stop_environment:
    %{
        %\__scontents_file_write_stop:N \l__scontents_macro_tmp_tl
        %\exp_args:NNNV
      %\group_end:
      %\tl_set:Nn \l__scontents_macro_tmp_tl \l__scontents_macro_tmp_tl
    %}
  %\cs_new_protected:Npn \__scontents_file_tl_write_start:n #1
    %{
      %\group_begin:
        %\bool_if:NT \l__scontents_writing_bool
          %{ 
            %\file_if_exist:nTF {#1}
              %{ \msg_warning:nnx { scontents } { rewriting-file } {#1} }
              %{ \msg_warning:nnx { scontents } { writing-file } {#1} }
            %\iow_open:Nn \l__scontents_file_iow {#1} 
          %}
        %\tl_clear:N \l__scontents_file_tl
        %\seq_map_function:NN \l_char_special_seq \char_set_catcode_other:N
        %\int_step_function:nnN { 128 } { 255 } \char_set_catcode_letter:n
        %\use:x
          %{
            %\cs_set:Npn \exp_not:N \__scontents_tmpa:w
              %####1 \c__scontents_end_env_tl
              %####2 \c__scontents_end_env_tl
              %####3 \exp_not:N \q_stop
              %{
                %\exp_not:N \tl_if_blank:nTF {####3}
                  %{
                    %\bool_if:NT \l__scontents_writing_bool
                      %{ \iow_now:Nn \l__scontents_file_iow {####1} }
                    %\bool_if:NT \l__scontents_storing_bool
                      %{ \tl_put_right:Nn \exp_not:N \l__scontents_file_tl { \exp_not:N ^^M ####1 } }
                  %}
                  %{
                    %\cs_set:Npn \exp_not:N \__scontents_M:w { \exp_not:N \end{scontents} }
                    %\char_set_active_eq:NN \exp_not:N ^^M \exp_not:N \__scontents_M:w
                  %}
                %\exp_not:N ^^M
              %}
          %}
        %\cs_set_protected:Npx \__scontents_M:w ##1 ^^M
          %{
            %\exp_not:N \__scontents_tmpa:w
            %##1 \c__scontents_end_env_tl
                %\c__scontents_end_env_tl
                %\exp_not:N \q_stop
          %}
        %\__scontents_make_control_chars_active:
    %}
  %\cs_new_protected:Npn \__scontents_file_write_stop:N #1
    %{
      %\bool_if:NT \l__scontents_writing_bool
        %{ \iow_close:N \l__scontents_file_iow }
      %\use:x
        %{
          %\group_end:
          %\bool_if:NT \l__scontents_storing_bool
            %{
              %\tl_set:Nn \exp_not:N #1
                %{ \exp_args:NV \__scontents_leading_cr:n \l__scontents_file_tl }
            %}
        %}
    %}
  %\cs_new:Npn \__scontents_leading_cr:n #1
    %{ \exp_not:o { \__scontents_leading_cr:w #1 } }
  %\cs_new:Npn \__scontents_leading_cr:w ^^M { }
  %\cs_gset_protected:Npn \__scontents_fcdef_print:N #1
    %{
      %\tl_if_blank:VT #1
        %{ \msg_error:nnn { scontents } { empty-variable } {#1} }
      %\cs_set_eq:NN \__scontents_fcdef_saved_EOL: ^^M
      %\cs_set_eq:NN ^^M \scan_stop:
      %\use:x
        %{
          %\exp_not:N \__scontents_rescan_tokens:w
            %{
              %\exp_not:N \begin{verbatimsc} ^^M
              %\__scontents_strip_scantokens:N #1 ^^M
              %\g__scontents_end_verbatimsc_tl
            %}
        %}
      %\cs_set_eq:NN ^^M \__scontents_fcdef_saved_EOL:
    %}
%\group_end:
%\cs_gset_protected:Npn \__scontents_atend_environment:
  %{
    %\bool_if:NT \l__scontents_storing_bool
      %{ \__scontents_stored_to_seq: }
    %\bool_if:NT \l__scontents_print_env_bool
      %{
        %\tl_gset:Nx \g__scontents_temp_tl
          %{ \__scontents_getfrom_seq:nn { -1 } { \l__scontents_name_seq_env_tl } }
        %\tl_gput_right:Nn \g__scontents_temp_tl { \tl_gclear:N \g__scontents_temp_tl }
        %\group_insert_after:N \g__scontents_temp_tl
      %}
    %\tl_clear:N \l__scontents_macro_tmp_tl
  %}
%\cs_generate_variant:Nn \__scontents_file_tl_write_start:n { V }
%\RenewDocumentCommand { \typestored } { s O{1} m }
  %{
    %\group_begin:
      %\tl_set:Nx \l__scontents_temp_tl { \__scontents_getfrom_seq:nn {#2} {#3} }
      %\tl_set:Nx \l__scontents_temp_tl { \__scontents_strip_scantokens:N \l__scontents_temp_tl }
      %\tl_replace_all:Nxx \l__scontents_temp_tl { \c__scontents_hidden_space_tl } { }
      %\tl_log:N \l__scontents_temp_tl
      %\IfBooleanTF {#1}
        %{ \bool_set_false:N \l__scontents_typeverb_env_bool }
        %{ \bool_set_true:N  \l__scontents_typeverb_env_bool }
      %\__scontents_fcdef_print:N \l__scontents_temp_tl
    %\group_end:   
  %}
%\ExplSyntaxOff

% custom :)
\makeatletter
\let\verbatimsc\@undefined
\let\endverbatimsc\@undefined
\makeatother
\DefineVerbatimEnvironment{verbatimsc}{Verbatim}{numbers=left,frame=single}
\begin{document}
\Scontents*[store-cmd=nospace]{Write in one line \LaTeX: $E=mc^2$, no space after dot.}

\Scontents*[store-cmd=nospace]{Other whit in one no space after dot.}

XX\getstored[1]{nospace}YY\par
XX\getstored[2]{nospace}YY\par

\typestored[1]{nospace}
\typestored[2]{nospace}
% These outputs should look the same
FIRST\par
This is normal text.
\verb|This is from the verb command.|
\verb*|This is from the verb* command.|    
This is normal text.
\begin{verbatim}
This is from the verbatim environment:
&%{}~
\end{verbatim}

SECOND\par
% These outputs should look the same whit print-env=true
\begin{scontents}[store-env=newattempt,print-env=false]
This is normal text.
\verb|This is from the verb command.|
\verb*|This is from the verb* command.|    
This is normal text.
\begin{verbatim}
This is from the verbatim environment:
&%{}~
\end{verbatim}
\end{scontents}This text is removed from the output because it is on the same line.
THIRD\par
% These outputs should look the same
\getstored[1]{newattempt}
% Tab
\begin{scontents}[write-out=withtab.tsc]
No tab
	One tab
		Two tab
\begin{verbatim}
      (E) verbatim
          environment
\end{verbatim}
\end{scontents}This text is removed from the output because it is on the same line.

\section{Test \texttt{\textbackslash Scontents[key=val]}}

Test \verb+\Scontents[print-cmd=false]+\par

\Scontents[print-cmd=false]{
Using \texttt{\textbackslash Scontents} command, \par
no environment verbatim suport,\par
but \Verb{fvextra inline yes} and \lstinline[basicstyle=\ttfamily]|lstinline yes|,
save in seq \texttt{contents} with index $1$.}\par

Test \verb+\Scontents[print-cmd=true]+\par

\Scontents[print-cmd=true]{
Using \texttt{\textbackslash Scontents} command, no environment verbatim suport,
but \Verb{fvextra inline yes} and \lstinline[basicstyle=\ttfamily]|lstinline yes|,
save in seq \texttt{contents} with index $2$.}

Test \verb+\Scontents[store-cmd=testcmd]+\par

\Scontents[store-cmd=testcmd]{
Using \texttt{\textbackslash Scontents} command, no environment verbatim suport,
but \Verb{fvextra inline yes} and \lstinline[basicstyle=\ttfamily]|lstinline yes|,
save in seq \texttt{testcmd} with index 1.}

\subsection{Test \texttt{\textbackslash getstored[index]\{seq name\}}}

\noindent\hrulefill

Test \verb+\getstored[1]{contents}+:\par

\getstored[1]{contents}

\noindent\hrulefill

Test \verb+\getstored[2]{contents}+:\par

\getstored[2]{contents}

\noindent\hrulefill

Test \verb+\getstored[1]{testcmd}+:\par

\getstored[1]{testcmd}

\noindent\hrulefill

\subsection{Test \texttt{\textbackslash meaningsc[index]\{seq name\}}}

\noindent\hrulefill

Test \verb+\meaningsc[1]{contents}+:\par

\meaningsc[1]{contents}

\noindent\hrulefill

Test \verb+\meaningsc[2]{contents}+:\par

\meaningsc[2]{contents}

\noindent\hrulefill

Test \verb+\meaningsc[1]{testcmd}+:\par

\meaningsc[1]{testcmd}

\noindent\hrulefill

\section{Test \texttt{\textbackslash Scontents*[key=val]}}

Test \verb+\setupsc{store-cmd=testcmdvrb}+\par
\setupsc{store-cmd=testcmdvrb}

Test \verb+\Scontents*[print-cmd=false]+\par

\Scontents*[print-cmd=false]{Using \texttt{\textbackslash Scontents*} command,

with verbatim suport.

\begin{verbatim*}
      verbatim
              environment
\end{verbatim*}

\Verb{fvextra inline yes}, save in seq \texttt{testcmdvrb} with index 1.}

Test \verb+\Scontents*[print-cmd=true]+\par
\Scontents*[print-cmd=true]|Using \verb/\Scontents*[print-cmd=true]+...+/ command, with verbatim suport,

\begin{verbatim}
      more verbatim environment
\end{verbatim}

And \Verb{fvextra inline yes}, save in seq \texttt{testcmdvrb} with index $2$.|

Test \verb+\Scontents[store-cmd=othervrb]+\par
\Scontents*[store-cmd=othervrb]{
Using \texttt{\textbackslash Scontents*} command, whit verbatim suport,

\begin{verbatim}
      other verbatim  environment
\end{verbatim}

And \Verb{fvextra inline yes}, save in seq \texttt{othervrb} with index $1$.}

\subsection{Test \texttt{\textbackslash getstored[index]\{seq name\}}}

\noindent\hrulefill

Test \verb+\getstored[1]{testcmdvrb}+:\par

\getstored[1]{testcmdvrb}

\noindent\hrulefill

Test \verb+\getstored[2]{testcmdvrb}+:\par

\getstored[2]{testcmdvrb}

\noindent\hrulefill

Test \verb+\getstored[1]{othervrb}+:\par

\getstored[1]{othervrb}

\noindent\hrulefill

\subsection{Test \texttt{\textbackslash meaningsc[index]\{seq name\}}}

\noindent\hrulefill

Test \verb+\meaningsc[1]{testcmdvrb}+:\par

\meaningsc[1]{testcmdvrb}

\noindent\hrulefill

Test \verb+\meaningsc[2]{testcmdvrb}+:\par

\meaningsc[2]{testcmdvrb}

\noindent\hrulefill

Test \verb+\meaningsc[1]{othervrb}+:\par

\meaningsc[1]{othervrb}

\noindent\hrulefill

\subsection{Test \texttt{\textbackslash typestored*[index]\{seq name\}}}

\noindent\hrulefill

Test \verb+\typestored*[1]{testcmdvrb}+:\par

\typestored*[1]{testcmdvrb}

\noindent\hrulefill

Test \verb+\typestored*[2]{testcmdvrb}+:\par

\typestored*[2]{testcmdvrb}

\noindent\hrulefill

Test \verb+\typestored*[1]{othervrb}+:\par

\typestored*[1]{othervrb}

\noindent\hrulefill

\section{Test \texttt{\textbackslash Scontents*} and \texttt{\textbackslash Scontents} back to default}

\Scontents[store-cmd=contents]{Using \texttt{\textbackslash Scontents} command whit braces,
save in seq \texttt{contents} with index $3$.}
\getstored[3]{contents}

\Scontents*|Using \texttt{\textbackslash Scontents*} command (verbatimized), save in seq \texttt{testcmdvrb} with index $3$.|
\getstored[3]{testcmdvrb}

\section{Test on mobile arguments}

\noindent\hrulefill

Test \verb+\subsection{\getstored[3]{testcmdvrb}}+:\par

\subsection{\getstored[3]{testcmdvrb}}

\noindent\hrulefill

Test \verb+\subsection{\getstored[3]{contents}}+:\par

\subsection{\getstored[3]{contents}}

\noindent\hrulefill

\section{Test \texttt{\{scontents\}} environment}
\setupsc{store-env=testenv, print-env=false}
\subsection{no \texttt{[key=val]}}
Test \verb+scontents+ no \verb+[key=val]+\par

\begin{scontents}
Using \verb+scontents+ env no \verb+[key=val]+, save in seq \verb+testenv+ index 1.\par
We have coded this in \LaTeX: $E=mc^2$.

Prove new \Verb*{ verbatim from fvextra whit braces } and environment \verb+Verbatim*+.
\begin{Verbatim*}
      (A) verbatim
          environment
\end{Verbatim*}
\end{scontents}

\subsubsection{\Verb{\getstored[1]{testenv}}}
\getstored[1]{testenv}

\subsubsection{\Verb{\meaningsc[1]{testenv}}}
\meaningsc[1]{testenv}

\subsubsection{\Verb{\typestored[1]{testenv}}}
\typestored[1]{testenv}

\subsection{whit \texttt{[key=val]}}

\subsubsection{\Verb{[write-env=\jobname.tsc]}}

\begin{scontents}[write-env=\jobname.tsc]
Using \verb+scontents+ env with \verb+[write-env=\jobname.tsc]+, save in
seq \verb+testenv+ with index 2 and write env body in file \verb+\jobname.tsc+.

We have coded this in \LaTeX: $E=mc^2$.\par
\begin{verbatim*}
      (B) verbatim
          environment
\end{verbatim*}
\end{scontents}

\subsubsection{\Verb{\getstored[2]{testenv}}}
\getstored[2]{testenv}

\subsubsection{\Verb{\meaningsc[2]{testenv}}}
\meaningsc[2]{testenv}

\subsubsection{\Verb{\typestored[2]{testenv}}}
\typestored[2]{testenv}

\subsubsection{\Verb{\VerbatimInput{\jobname.tsc}}}

\VerbatimInput[frame=single,numbers=left,numbersep=3pt]{\jobname.tsc}

\subsubsection{\Verb{[print-env=true]}}

\begin{scontents}[print-env=true]
Using \verb+scontents+ env with \verb+[print-env=true]+, save in
seq \verb+testenv+ with index 3.

We have coded this in \LaTeX: $E=mc^2$.\par
\begin{verbatim*}
      (C) verbatim
          environment
\end{verbatim*}
\end{scontents}

\Verb{\getstored[3]{testenv}}\par
\getstored[3]{testenv}\par

\Verb{\meaningsc[3]{testenv}}\par
\meaningsc[3]{testenv}\par

\Verb{\typestored[3]{testenv}}\par
\typestored[3]{testenv}

\subsubsection{\Verb{[print-env=true,write-env=\jobname-1.tsc]}}

\begin{scontents}[print-env=true,write-env=\jobname-1.tsc]
Using \verb+scontents+ env with \verb+[print-env=true,write-env=\jobname-1.tsc]+, save in
seq \verb+testenv+ with index 4.

We have coded this in \LaTeX: $E=mc^2$.\par
\begin{verbatim*}
      (D) verbatim
          environment
\end{verbatim*}
\end{scontents}

\Verb{\getstored[4]{testenv}}\par
\getstored[4]{testenv}\par

\Verb{\meaningsc[4]{testenv}}\par
\meaningsc[4]{testenv}\par

\Verb{\typestored[4]{testenv}}\par
\typestored[4]{testenv}

\Verb{\VerbatimInput{\jobname-1.tsc}}\par

\VerbatimInput[frame=single,numbers=left,numbersep=3pt]{\jobname-1.tsc}

\subsection{\Verb{[write-out=\jobname-2.tsc]}}

\begin{scontents}[write-out=\jobname-2.tsc]
Using \verb+scontents+ env with \verb+[write-out=\jobname-2.tsc]+,
not added to seq, only write a external file
We have coded this in \LaTeX: $E=mc^2$.\par
\begin{verbatim}
      (E) verbatim
          environment
\end{verbatim}
\end{scontents}

\Verb{\VerbatimInput{\jobname-2.tsc}}\par

\VerbatimInput[frame=single,numbers=left,numbersep=3pt]{\jobname-2.tsc}

\subsubsection{\Verb{[print-env=true,store-env=other]}}

\begin{scontents}[print-env=true,store-env=other]
Using \verb+scontents+ env with \verb+[print-env=true,store-env=other]+, save in
seq \verb+other+ with index 1.

We have coded this in \LaTeX: $E=mc^2$.\par
\begin{verbatim*}
      (F) verbatim
          environment
\end{verbatim*}
\end{scontents}

\Verb{\getstored[1]{other}}\par
\getstored[1]{other}\par

\Verb{\meaningsc[1]{other}}\par
\meaningsc[1]{other}\par

\Verb{\typestored[1]{other}}\par
\typestored[1]{other}

\section{A simple aplication}
\setupsc{ store-env=answers, store-cmd= answers }

\newcounter{exeNr}
\newenvironment{exercise}
  {\refstepcounter{exeNr}\par\noindent This is exercise~\theexeNr}
  {\par}
\subsection{Exercises}
\begin{exercise}
\end{exercise}
\begin{scontents}
This is the answer to exercise 1, the shebang line for a Perl script

\begin{verbatim}
#!/usr/bin/env perl
\end{verbatim}
\end{scontents}

\begin{exercise}
\end{exercise}
\Scontents*{This is the answer to exercise 2}

\begin{exercise}
\end{exercise}
\Scontents[unknow]{This is the answer to exercise 3}

\subsection{Answers}
\newcounter{ansNr}
\newenvironment{answer}
  {\refstepcounter{ansNr}\par\noindent Answer~\theansNr:}
  {\par}

\foreach \i in {1,...,\countsc{answers}} {
\begin{answer}
\getstored[\i]{answers}
\end{answer}
}
\subsection{typestored}
% custom :)
\makeatletter
\let\verbatimsc\@undefined
\let\endverbatimsc\@undefined
\makeatother
\DefineVerbatimEnvironment{verbatimsc}{Verbatim}{numbers=left,frame=single}
\typestored[1]{answers}
\typestored[2]{answers}
\end{document}
